# BlankLogo - Local Development Docker Compose
# Run: docker-compose up -d

version: '3.8'

services:
  # Redis for job queue
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Service
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=development
      - PORT=8080
      - REDIS_URL=redis://redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - CORS_ORIGINS=http://localhost:3838,http://localhost:3000
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Worker Service
  worker:
    build:
      context: .
      dockerfile: apps/worker/Dockerfile
    environment:
      - NODE_ENV=development
      - REDIS_URL=redis://redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - WORKER_ID=worker-docker-1
      - WORKER_CONCURRENCY=2
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - worker_temp:/tmp

  # Web Frontend (for local dev, run separately with pnpm dev)
  # Uncomment to build production version
  # web:
  #   build:
  #     context: .
  #     dockerfile: apps/web/Dockerfile
  #   ports:
  #     - "3838:3838"
  #   environment:
  #     - NEXT_PUBLIC_API_URL=http://localhost:8080
  #   depends_on:
  #     - api

volumes:
  redis_data:
  worker_temp:

networks:
  default:
    name: blanklogo-network

name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
  DEV_NOTIFICATION_EMAIL: ${{ secrets.DEV_NOTIFICATION_EMAIL }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run unit tests
        run: pnpm test:unit
        
      - name: Run lint
        run: pnpm lint || true

  build-api:
    name: Build API
    needs: test
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build API Docker image
        id: build
        run: |
          docker build -f apps/api/Dockerfile -t blanklogo-api:${{ github.sha }} .
          
      - name: Notify build started
        if: always()
        run: |
          curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"service":"api","status":"building","commit":"${{ github.sha }}"}'
        continue-on-error: true

  build-worker:
    name: Build Worker
    needs: test
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build Worker Docker image
        id: build
        run: |
          docker build -f apps/worker/Dockerfile -t blanklogo-worker:${{ github.sha }} .

  build-web:
    name: Build Web
    needs: test
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build Web Docker image
        id: build
        run: |
          docker build -f apps/web/Dockerfile -t blanklogo-web:${{ github.sha }} .

  deploy:
    name: Deploy to Railway
    needs: [build-api, build-worker, build-web]
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
        
      - name: Deploy API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          railway up -s api
          
      - name: Deploy Worker
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up -s worker
          
      - name: Deploy Web
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up -s web

  post-deploy-tests:
    name: Post-Deployment Tests
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Install Playwright
        run: pnpm exec playwright install --with-deps chromium
        
      - name: Wait for deployment to stabilize
        run: sleep 30
        
      - name: Run smoke tests
        env:
          DEPLOY_API_URL: ${{ secrets.PRODUCTION_API_URL }}
          DEPLOY_WEB_URL: ${{ secrets.PRODUCTION_WEB_URL }}
        run: pnpm test:deployment:smoke
        
      - name: Run health checks
        env:
          DEPLOY_API_URL: ${{ secrets.PRODUCTION_API_URL }}
          DEPLOY_WEB_URL: ${{ secrets.PRODUCTION_WEB_URL }}
        run: pnpm test:deployment:health

  notify:
    name: Send Notifications
    needs: [deploy, post-deploy-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install resend
        
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ] && [ "${{ needs.post-deploy-tests.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
          
      - name: Send notification
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          DEV_NOTIFICATION_EMAIL: ${{ secrets.DEV_NOTIFICATION_EMAIL }}
        run: |
          npx tsx scripts/deploy-notify.ts \
            --status=${{ steps.status.outputs.status }} \
            --service=all \
            --env=${{ github.event.inputs.environment || 'production' }} \
            --commit=${{ github.sha }} \
            --message="${{ github.event.head_commit.message }}"
